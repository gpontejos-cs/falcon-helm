{{- if .Values.testing.enabled -}}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "falcon-kac.fullname" . }}-test-deployment-running"
  namespace: {{ include "falcon-kac.namespace" . }}
  labels:
    {{- include "falcon-kac.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test-success
spec:
  containers:
    - name: kubectl
      image: docker.io/bitnami/kubectl
      command:
      - /bin/sh
      - -c
      - |
        echo "Waiting 20 seconds to allow deployment time to initialize before running test"
        sleep 20

        echo "Checking if falcon-kac deployment is running..."
        DEPLOYMENT_STATUS=$(kubectl get deployment {{ include "falcon-kac.name" . }} -n {{ include "falcon-kac.namespace" . }} -o jsonpath="{.status.readyReplicas}")
        DESIRED_REPLICAS=$(kubectl get deployment {{ include "falcon-kac.name" . }} -n {{ include "falcon-kac.namespace" . }} -o jsonpath="{.spec.replicas}")

        if [ "${DEPLOYMENT_STATUS}" != "${DESIRED_REPLICAS}" ]; then
            echo "[\033[0;31mFAIL\033[0m]: falcon-kac deployment is not ready. Expected ${DESIRED_REPLICAS} replicas, got ${DEPLOYMENT_STATUS}"
            kubectl get deployment {{ include "falcon-kac.name" . }} -n {{ include "falcon-kac.namespace" . }}
            kubectl describe deployment {{ include "falcon-kac.name" . }} -n {{ include "falcon-kac.namespace" . }}
            exit 1
        fi

        echo "Checking if falcon-kac pod is running..."
        POD_STATUS=$(kubectl get pods -n {{ include "falcon-kac.namespace" . }} -l app={{ include "falcon-kac.name" . }} --field-selector=status.phase=Running --no-headers 2>&1)
        if echo "${POD_STATUS}" | grep -q "No resources found"; then
            echo "[\033[0;31mFAIL\033[0m]: falcon-kac pod is not running"
            echo "${POD_STATUS}"
            kubectl describe pods -n {{ include "falcon-kac.namespace" . }} -l app={{ include "falcon-kac.name" . }}
            exit 1
        fi

        echo "[\033[0;32mOK\033[0m]: falcon-kac deployment and pod are running successfully"
        exit 0
      securityContext:
        runAsUser: 0
        privileged: true
        readOnlyRootFilesystem: false
        allowPrivilegeEscalation: true
  serviceAccountName: {{ .Values.serviceAccount.name }}
  restartPolicy: Never
{{- end -}}