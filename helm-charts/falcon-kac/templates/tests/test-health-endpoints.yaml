{{- if .Values.testing.enabled -}}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "falcon-kac.fullname" . }}-test-health-endpoints"
  namespace: {{ include "falcon-kac.namespace" . }}
  labels:
    {{- include "falcon-kac.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test-success
spec:
  containers:
    - name: kubectl-curl
      image: docker.io/bitnami/kubectl:latest
      command:
      - /bin/sh
      - -c
      - |
        echo "Waiting 30 seconds to allow falcon-kac to be fully ready before testing health endpoints"
        sleep 30

        echo "=== DIAGNOSTIC PHASE ==="
        echo "Checking test pod permissions and environment..."
        id
        echo "Kubectl version:"
        kubectl version --client || true
        echo ""

        echo "Checking if kubectl can access the cluster..."
        kubectl get namespaces >/dev/null 2>&1 && echo "✓ kubectl cluster access OK" || echo "✗ kubectl cluster access FAILED"

        echo "Checking namespace access..."
        kubectl get pods -n {{ include "falcon-kac.namespace" . }} >/dev/null 2>&1 && echo "✓ namespace access OK" || echo "✗ namespace access FAILED"

        echo "Checking service account permissions..."
        kubectl auth can-i get pods -n {{ include "falcon-kac.namespace" . }} && echo "✓ can get pods" || echo "✗ cannot get pods"
        kubectl auth can-i get services -n {{ include "falcon-kac.namespace" . }} && echo "✓ can get services" || echo "✗ cannot get services"

        echo ""
        echo "=== POD DISCOVERY PHASE ==="
        echo "Looking for falcon-kac pods..."
        kubectl get pods -n {{ include "falcon-kac.namespace" . }} -l app={{ include "falcon-kac.name" . }} -o wide || true
        echo ""

        # Get the pod IP directly from kubectl with detailed debugging
        echo "Attempting to get pod IP..."
        POD_IP=$(kubectl get pod -n {{ include "falcon-kac.namespace" . }} -l app={{ include "falcon-kac.name" . }} -o jsonpath='{.items[0].status.podIP}' 2>/dev/null)
        echo "Pod IP result: '${POD_IP}'"

        if [ -z "${POD_IP}" ] || [ "${POD_IP}" = "null" ]; then
            echo "[\033[0;31mFAIL\033[0m]: Could not get falcon-kac pod IP"
            echo "Detailed pod information:"
            kubectl get pods -n {{ include "falcon-kac.namespace" . }} -l app={{ include "falcon-kac.name" . }} -o yaml || true
            exit 1
        fi
        echo "✓ Found falcon-kac pod IP: ${POD_IP}"

        echo ""
        echo "=== POD STATUS VERIFICATION ==="
        POD_NAME=$(kubectl get pod -n {{ include "falcon-kac.namespace" . }} -l app={{ include "falcon-kac.name" . }} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null)
        echo "Pod name: ${POD_NAME}"

        echo "Checking pod readiness..."
        POD_READY=$(kubectl get pod ${POD_NAME} -n {{ include "falcon-kac.namespace" . }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "Unknown")
        echo "Pod Ready status: ${POD_READY}"

        echo "Checking container statuses..."
        kubectl get pod ${POD_NAME} -n {{ include "falcon-kac.namespace" . }} -o jsonpath='{range .status.containerStatuses[*]}{.name}: {.ready}{"\n"}{end}' || true

        echo ""
        echo "=== NETWORK CONNECTIVITY TESTS ==="
        echo "Testing basic network connectivity to pod..."

        # Test if we can ping the pod
        echo "Testing ping to ${POD_IP}..."
        if ping -c 1 -W 3 ${POD_IP} >/dev/null 2>&1; then
            echo "✓ Ping to ${POD_IP} successful"
        else
            echo "✗ Ping to ${POD_IP} failed (this may be normal if ICMP is blocked)"
        fi

        # Test if the ports are listening using netcat-like functionality with curl
        echo "Testing port connectivity..."
        echo "  Testing watcher port {{ .Values.watcherPort }}..."
        if timeout 5 curl -s --connect-timeout 3 http://${POD_IP}:{{ .Values.watcherPort }} >/dev/null 2>&1; then
            echo "  ✓ Port {{ .Values.watcherPort }} is reachable"
        else
            echo "  ✗ Port {{ .Values.watcherPort }} is not reachable"
        fi

        echo "  Testing webhook port {{ .Values.webhookPort }}..."
        if timeout 5 curl -s -k --connect-timeout 3 https://${POD_IP}:{{ .Values.webhookPort }} >/dev/null 2>&1; then
            echo "  ✓ Port {{ .Values.webhookPort }} is reachable"
        else
            echo "  ✗ Port {{ .Values.webhookPort }} is not reachable"
        fi

        echo ""
        echo "=== HEALTH ENDPOINT TESTS ==="
        echo "Testing falcon-watcher health endpoint..."

        # Test with detailed curl output first
        echo "Detailed curl test for watcher endpoint:"
        echo "Command: curl -s -k -w 'HTTP_CODE:%{http_code}' --connect-timeout 10 --max-time 15 http://${POD_IP}:{{ .Values.watcherPort }}/livez"
        DETAILED_WATCHER_RESULT=$(curl -s -k -w "HTTP_CODE:%{http_code}" --connect-timeout 10 --max-time 15 http://${POD_IP}:{{ .Values.watcherPort }}/livez 2>&1 || echo "CURL_ERROR:$?")
        echo "Full curl result: '${DETAILED_WATCHER_RESULT}'"

        # Extract just the HTTP code
        WATCHER_HEALTH=$(echo "${DETAILED_WATCHER_RESULT}" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2 2>/dev/null || echo "000")
        echo "Extracted HTTP code: '${WATCHER_HEALTH}'"
        if [ "${WATCHER_HEALTH}" != "200" ]; then
            echo "[\033[0;33mWARN\033[0m]: falcon-watcher direct health check failed. HTTP status: ${WATCHER_HEALTH}"
            echo "This might be due to network policies restricting pod-to-pod communication"
            echo "Checking if the watcher container is running and has the right probes..."
            kubectl describe pod -n {{ include "falcon-kac.namespace" . }} -l app={{ include "falcon-kac.name" . }} | grep -A 10 -B 5 "falcon-watcher" || true
        else
            echo "[\033[0;32mOK\033[0m]: falcon-watcher health endpoint is responding"
        fi

        {{- if .Values.admissionControl.enabled }}
        echo "Testing falcon-client and falcon-ac health endpoints (HTTPS)..."

        # Try via service first (webhook service exposes port 443 -> webhookPort)
        WEBHOOK_SERVICE_IP=$(kubectl get service webhook -n {{ include "falcon-kac.namespace" . }} -o jsonpath='{.spec.clusterIP}' 2>/dev/null || echo "")
        if [ -n "${WEBHOOK_SERVICE_IP}" ] && [ "${WEBHOOK_SERVICE_IP}" != "null" ]; then
            echo "Testing via webhook service (${WEBHOOK_SERVICE_IP}:443)..."
            CLIENT_HEALTH=$(curl -s -k -w "%{http_code}" -o /dev/null --connect-timeout 10 --max-time 15 https://${WEBHOOK_SERVICE_IP}:443/livez 2>/dev/null || echo "000")
            AC_HEALTH=$(curl -s -k -w "%{http_code}" -o /dev/null --connect-timeout 10 --max-time 15 https://${WEBHOOK_SERVICE_IP}:443/livez-kac 2>/dev/null || echo "000")
        else
            echo "Webhook service not found, testing via direct pod access..."
            CLIENT_HEALTH=$(curl -s -k -w "%{http_code}" -o /dev/null --connect-timeout 10 --max-time 15 https://${POD_IP}:{{ .Values.webhookPort }}/livez 2>/dev/null || echo "000")
            AC_HEALTH=$(curl -s -k -w "%{http_code}" -o /dev/null --connect-timeout 10 --max-time 15 https://${POD_IP}:{{ .Values.webhookPort }}/livez-kac 2>/dev/null || echo "000")
        fi

        if [ "${CLIENT_HEALTH}" != "200" ]; then
            echo "[\033[0;33mWARN\033[0m]: falcon-client health check failed. HTTP status: ${CLIENT_HEALTH}"
            echo "This might be due to network policies or the service not being ready"
        else
            echo "[\033[0;32mOK\033[0m]: falcon-client health endpoint is responding"
        fi

        if [ "${AC_HEALTH}" != "200" ]; then
            echo "[\033[0;33mWARN\033[0m]: falcon-ac health check failed. HTTP status: ${AC_HEALTH}"
            echo "This might be due to network policies or the service not being ready"
        else
            echo "[\033[0;32mOK\033[0m]: falcon-ac health endpoint is responding"
        fi
        {{- else }}
        echo "[\033[0;33mSKIP\033[0m]: Admission control is disabled, skipping HTTPS health endpoint tests"
        {{- end }}

        # Final status based on what we could test
        echo ""
        echo "=== Health Endpoint Test Summary ==="
        echo "This test checks if falcon-kac health endpoints are accessible."
        echo "Note: Some failures may be due to network policies in production environments."
        echo "The deployment itself may still be healthy even if direct health endpoint access fails."
        echo ""
        echo "For production monitoring, consider:"
        echo "1. Using service monitors or ingress for health checks"
        echo "2. Checking the deployment and pod status instead of direct endpoint access"
        echo "3. Configuring network policies to allow health endpoint access if needed"
        echo ""
        echo "[\033[0;32mOK\033[0m]: Health endpoint connectivity test completed"
        exit 0
      securityContext:
        runAsUser: 0
        privileged: true
        readOnlyRootFilesystem: false
        allowPrivilegeEscalation: true
  serviceAccountName: {{ .Values.serviceAccount.name }}
  restartPolicy: Never
{{- end -}}